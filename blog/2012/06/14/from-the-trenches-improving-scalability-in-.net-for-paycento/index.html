
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>From the trenches - improving scalability in .Net for Paycento - Tom's ramblings</title>
	<meta name="author" content="Tom Janssens">

	
	<meta name="description" content="From the Trenches - Improving Scalability in .Net for Paycento Introduction
As most of you might know, I am currently in the process of improving &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Tom's ramblings" type="application/atom+xml">
	
	<link rel="canonical" href="http://tojans.github.io/blog/2012/06/14/from-the-trenches-improving-scalability-in-.net-for-paycento/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("tom@corebvba.be") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
</div>
<hgroup>
  <h1><a href="/">Tom's ramblings</a></h1>
  
    <p class="subtitle">Random opinionated blurbs</p>
  
</hgroup>

<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Tom</a></li>
</ul>


<section class="aboutme">
  <p>
    <p>Tom builds software and helps organisations to get better at building software.</p>

  </p>
</section>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/tojans" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/tojans" title="GitHub">GitHub</a>
		
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/tomjanssens">LinkedIn</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">From the Trenches - Improving Scalability in .Net for Paycento</h1>
	<div class="entry-content" itemprop="articleBody"><h3>Introduction</h3>
<p>As most of you might know, I am currently in the process of improving the scalability of the <a href="http://www.paycento.com/" target="_blank">Paycento </a>backend..</p>
<p>As a real lean adept, the idea is to optimize where it hurts&#8230; As the creator of Node.js pointed out perfectly, the biggest pain is in the disk/network access etc.. Blocking threads hurt bigtime&#8230; So I started searching for easy low-cost optimizations that would not require to much effort&#8230;.</p>
<p>
<object width="640" height="360">
<param name="movie" value="http://www.youtube.com/v/M-sc73Y-zQA?version=3&amp;hl=nl_NL" />
<param name="allowFullScreen" value="true" />
<param name="allowscriptaccess" value="always" /><embed type="application/x-shockwave-flash" width="640" height="360" src="http://www.youtube.com/v/M-sc73Y-zQA?version=3&amp;hl=nl_NL" allowscriptaccess="always" allowfullscreen="true"></embed>
</object>
</p>
<p>&nbsp;</p>
<h3>Before we begin: Phase 0 - measuring=knowing; ask Heracles</h3>
<p></p>
<p>&nbsp;</p>
<p>I spent a big part of last month coding a command line app called &#8220;Heracles&#8221;, which is some kind of a helper app. It supports the following commands:</p>
<ul>
<li>checkout : downloads source and all solutions from SVN and puts them in the folders following our convention</li>
<li>build: builds all the source and publishes it to the publish &amp; publishweb folders</li>
<li>db: we have a &#8220;db drop xxx&#8221; and a &#8220;db restore xxx&#8221;, which downloads a backup from our ref db from the web and restores it in SQL Express..</li>
<li>install: this is a simple wrapper that invokes chocolatey or downloads installer packages from the web, so we all have the same dev environment. &#8220;Heracles install *&#8221; is all one needs to have all the required prerequisites</li>
<li>performancetest: restores the db, fires up the api WCF service with this db, fires up memcached and then runs all integration tests that have the category &#8220;integration&#8221; and &#8220;speed&#8221;. (simple MStest invoke, capturing relevant output). We redirect trace output to the console and append performance output in logs, so we have a log that contains every single performance test we ran&#8230;.</li>
</ul>
<div style="text-align: left; ">This tool allows us to effectively measure our code adjustments in a few minutes, using two simple commands (&#8220;heracles build&#8221; and &#8220;heracles performancetest&#8221;).</div>
<div>This implies we can measure if our effort is actually resulting in some real improvements&#8230;</div>
<p>&nbsp;</p>
<h3>First things first: Caching</h3>
<p>The easiest way to speed up network/disk access, is simply avoiding it, so I started with caching the part that requires scalability&#8230;</p>
<p>Caching is an essential part of scalable websites, and there is no need to reinvent the wheel here&#8230; I started of with a simple static in-memory dictionary to verify my hunches, and then I started considering established options&#8230;&nbsp;After some reading up between different caching solutions, I found it hard to decide which option to select, but luckily I found the wonderfull <a href="http://www.nuget.org/packages/Glav.CacheAdapter" target="_blank">CacheAdapter written and maintained by Paul Glavich</a>. It allows you to switch between different caching types by altering web/app.config. The current cache options are:</p>
<ul>
<li>No cache</li>
<li>.Net 4.0 ObjectCache</li>
<li>Asp.Net Cache</li>
<li>Appfabric cache</li>
<li>Memcached</li>
</ul>
<p>This improved performance bigtime wiithout a lot of effort.</p>
<p>&nbsp;</p>
<h3>Up next: blocking IO requests hurt bigtime</h3>
<p>After considering the option to convert our WCF service into an async one (way to much effort for now), I discovered that one can easily improve performance of parallel requests by replacing simple calls with their async counterpart and just wait for them to complete&#8230;</p>
<p>I wrote a simple benchmark to download my homepage 20 times using async &amp; sync approaches, and the results were unbelievable:</p>
<p><strong><em>The async method was 28 times faster then the sync method&#8230;</em></strong></p>
<p>How does it work ?</p>
<p>It is actually quite simple; I wrote a little helper function in a static class called Wait.Async. Here is the complete sample code with the stats included, let us take a look first:</p>
<p>
<script src="https://gist.github.com/2929935.js?file=asynctest.cs"></script>
</p>
<p>So, the code is really simple; I simple wait for the ResetEvent to be set&#8230; As this is quite repetetive code I wrote a little helper for it&#8230;</p>
<p>&nbsp;</p>
<h3>Can we use it to optimize database access ? Even Linq2SQL ?</h3>
<p>It is a little hackerisch for LinqToSQL and it has its limitations for the queries, but it is actually quite easy to do so&#8230; As we are a big fan of the community and like to give back, we offer you the code we use to improve LinqToSQL scalability.</p>
<p>&nbsp;</p>
<p>
<script src="https://gist.github.com/2929935.js?file=Paycento.API.Tasks.cs"></script>
</p>
<p>Unfortunately non-selects are AFAIK (close to) impossible to make async, so we currently simply opt to update the cached values directly and process the SQL on a background thread&#8230;</p>
<p>&nbsp;</p>
<h3>What&#8217;s up next ?</h3>
<p>For now, we have the tools and options in place to start optimizing the code&#8230; We applied the principles to 2 execution paths that require performance, and reached our initial performance goal. So now we need to optimize other paths as well. As my pseudo-fulltime consultancy period for Paycento is about to end next week, I can only assume it will be quite a busy week.. Fortunately, I will still be a member of the Paycento team, even though it will (for now) be more on an ad-hoc basis&#8230;</p><div style="text-align:right"><a class="addthis_button" href="http://www.addthis.com/bookmark.php?v=250&amp;pub=xa-4aec37702e3161d4"><img src="http://s7.addthis.com/static/btn/v2/lg-share-en.gif" width="125" height="16" alt="Bookmark and Share" style="border:0"/></a><script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pub=xa-4aec37702e3161d4"></script></div>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2013 - Tom Janssens -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'tojansramblings';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-41936060-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>




		</div>
	</div>
</body>
</html>
